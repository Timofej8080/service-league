<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–°–µ—Ä–≤–∏—Å–Ω–∞—è –õ–∏–≥–∞ ‚Äî VK Bridge + Supabase</title>
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <style>
    /* –¢–≤–æ–π CSS –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #1a202c, #0f172a);
      color: #e0e7ff;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .card {
      background: #1e293b;
      padding: 36px 40px 40px 40px;
      border-radius: 18px;
      box-shadow: 0 8px 24px rgba(50, 50, 93, 0.25), 0 4px 16px rgba(0, 0, 0, 0.3);
      text-align: center;
      width: 420px;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    h1, h2, h3 {
      margin: 0 0 20px 0;
      font-weight: 600;
      color: #cbd5e1;
      text-shadow: 0 1px 3px rgba(0,0,0,0.4);
    }
    h1 { font-size: 28px; }
    h2 { font-size: 22px; }
    h3 { font-size: 18px; }
    .username {
      margin-bottom: 35px;
      color: #94a3b8;
      font-weight: 700;
      font-size: 20px;
      letter-spacing: 0.05em;
      user-select: none;
      word-break: break-word;
    }
    p {
      margin: 0 0 18px 0;
      line-height: 1.5;
      color: #a0aec0;
      font-size: 15px;
    }
    button {
      background: #3b82f6;
      border: none;
      padding: 14px 28px;
      border-radius: 12px;
      color: #f1f5f9;
      font-size: 17px;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease, box-shadow 0.25s ease;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.6);
      user-select: none;
      margin-bottom: 14px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    button:hover {
      background: #2563eb;
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.8);
    }
    button:active {
      background: #1e40af;
      box-shadow: 0 3px 8px rgba(30, 64, 175, 0.9);
      transform: translateY(1px);
    }
    #tickets-list {
      overflow-y: auto;
      max-height: 230px;
      margin-bottom: 28px;
      border-radius: 12px;
      background: #334155;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
      padding: 12px 8px;
      scrollbar-width: thin;
      scrollbar-color: #60a5fa #1e293b;
    }
    #tickets-list::-webkit-scrollbar {
      width: 10px;
    }
    #tickets-list::-webkit-scrollbar-track {
      background: #1e293b;
      border-radius: 12px;
    }
    #tickets-list::-webkit-scrollbar-thumb {
      background-color: #60a5fa;
      border-radius: 12px;
      border: 2px solid #1e293b;
    }
    #tickets-list button {
      background: #2563eb;
      width: 100%;
      text-align: left;
      padding: 14px 16px;
      margin-bottom: 12px;
      font-size: 15px;
      border-radius: 10px;
      font-weight: 600;
      color: #e0e7ff;
      box-shadow: 0 2px 8px rgba(37, 99, 235, 0.6);
      transition: background-color 0.25s ease;
    }
    #tickets-list button:hover:not(.answered) {
      background: #3b82f6;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.8);
    }
    #tickets-list button.answered {
      background: #22c55e;
      color: #0f172a;
      text-decoration: line-through;
      box-shadow: 0 2px 8px rgba(34, 197, 94, 0.7);
      cursor: default;
    }
    #ticket-details {
      text-align: left;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
    }
    #client-message {
      background:#475569;
      padding: 16px;
      border-radius: 14px;
      min-height: 70px;
      margin-bottom: 18px;
      color: #e2e8f0;
      font-size: 15px;
      white-space: pre-wrap;
      box-shadow: inset 0 0 8px rgba(0,0,0,0.2);
    }
    textarea {
      resize: none;
      font-family: 'Inter', sans-serif;
      font-size: 15px;
      padding: 14px;
      border-radius: 14px;
      border: none;
      margin-bottom: 18px;
      width: 100%;
      box-sizing: border-box;
      box-shadow: 0 0 12px rgba(59, 130, 246, 0.3);
      transition: box-shadow 0.3s ease;
      color: #f1f5f9;
      background: #1e293b;
    }
    textarea:focus {
      outline: none;
      box-shadow: 0 0 20px #3b82f6;
      background: #293544;
    }
    #send-answer {
      background: #10b981;
      box-shadow: 0 5px 15px rgba(16, 185, 129, 0.7);
    }
    #send-answer:hover {
      background: #059669;
      box-shadow: 0 7px 18px rgba(5, 150, 105, 0.8);
    }
    #send-answer:active {
      background: #047857;
      box-shadow: 0 3px 10px rgba(4, 120, 87, 0.9);
      transform: translateY(1px);
    }
    #end-shift {
      background: #ef4444;
      margin-top: auto;
      font-weight: 700;
      box-shadow: 0 5px 18px rgba(239, 68, 68, 0.7);
    }
    #end-shift:hover {
      background: #b91c1c;
      box-shadow: 0 7px 20px rgba(185, 28, 28, 0.85);
    }
    #end-shift:active {
      background: #7f1d1d;
      box-shadow: 0 3px 12px rgba(127, 29, 29, 1);
      transform: translateY(1px);
    }
  </style>
</head>
<body>

  <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
  <div id="welcome-screen" class="card" role="main" aria-label="–≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è">
    <h1>–°–µ—Ä–≤–∏—Å–Ω–∞—è –õ–∏–≥–∞</h1>
    <div class="username" id="nickname" aria-live="polite">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <p>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ—á–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É!</p>
    <p>–í–∞—à–∞ –∑–∞–¥–∞—á–∞ ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤.</p>
    <button id="start-shift-btn" aria-label="–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É">üöÄ –ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É</button>
  </div>

  <!-- –†–∞–±–æ—á–∏–π —ç–∫—Ä–∞–Ω -->
  <div id="work-screen" class="card" style="display:none;" role="main" aria-label="–†–∞–±–æ—á–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å">
    <h2>–†–∞–±–æ—á–∏–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å</h2>
    <div id="tickets-list" aria-label="–°–ø–∏—Å–æ–∫ –æ–±—Ä–∞—â–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤" tabindex="0"></div>

    <div id="ticket-details" style="text-align:left;">
      <h3>–î–µ—Ç–∞–ª–∏ –æ–±—Ä–∞—â–µ–Ω–∏—è</h3>
      <p><strong>–°–æ–æ–±—â–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞:</strong></p>
      <p id="client-message" style="background:#334155; padding: 12px; border-radius: 8px; min-height: 60px;" aria-live="polite"></p>
      <p><strong>–í–∞—à –æ—Ç–≤–µ—Ç:</strong></p>
      <textarea id="answer-text" rows="4" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç..." aria-label="–ü–æ–ª–µ –¥–ª—è –≤–≤–æ–¥–∞ –æ—Ç–≤–µ—Ç–∞"></textarea>
      <button id="send-answer" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
    </div>

    <button id="end-shift" aria-label="–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É">‚è∞ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É</button>
  </div>

  <script>
    // VK Bridge init
    vkBridge.send('VKWebAppInit');

    // Supabase init - –≤—Å—Ç–∞–≤—å —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
    const SUPABASE_URL = 'https://duwhvbffcrtqpohihdoo.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR1d2h2YmZmY3J0cXBvaGloZG9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI4NjQ3NzMsImV4cCI6MjA2ODQ0MDc3M30.8Rwgy3hH8D45QmHPdxxP-GhEo6smgxtlWrMwIQHzsuo';
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // –ù–∏–∫–Ω–µ–π–º –ø–æ user_id –í–ö
    function createNicknameFromUserId(userId) {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
      let suffix = '';
      let num = Number(userId);
      for (let i = 0; i < 3; i++) {
        suffix += letters[num % letters.length];
        num = Math.floor(num / letters.length);
      }
      return `User${userId}-${suffix}`;
    }

    async function loadUserNickname() {
      try {
        const userInfo = await vkBridge.send('VKWebAppGetUserInfo');
        if (userInfo && userInfo.id) {
          return createNicknameFromUserId(userInfo.id);
        }
      } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ:', e);
      }
      return 'Guest' + Math.floor(Math.random() * 10000);
    }

    // –¢–∏–∫–µ—Ç—ã –∏–∑ Supabase
    let tickets = [];
    let currentTicketId = null;

    async function fetchTickets() {
      const { data, error } = await supabase
        .from('tickets')
        .select('*')
        .order('id', { ascending: true });

      if (error) {
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–∫–µ—Ç–æ–≤: ' + error.message);
        console.error(error);
        return;
      }
      tickets = data;
    }

    function renderTickets() {
      const container = document.getElementById('tickets-list');
      container.innerHTML = '';
      tickets.forEach(ticket => {
        const btn = document.createElement('button');
        btn.textContent = ticket.answered
          ? `‚úÖ ${ticket.message}`
          : ticket.message;
        btn.disabled = ticket.answered;
        btn.className = ticket.answered ? 'answered' : '';
        btn.setAttribute('aria-pressed', ticket.id === currentTicketId ? 'true' : 'false');
        btn.onclick = () => selectTicket(ticket.id);
        container.appendChild(btn);
      });
    }

    function selectTicket(id) {
      currentTicketId = id;
      const ticket = tickets.find(t => t.id === id);
      if (!ticket) return;

      document.getElementById('client-message').textContent = ticket.message;
      document.getElementById('answer-text').value = ticket.answer || '';
      updateSendButton();
      highlightSelectedTicket();
    }

    function highlightSelectedTicket() {
      const buttons = document.querySelectorAll('#tickets-list button');
      buttons.forEach(btn => {
        btn.setAttribute('aria-pressed', 'false');
        if (tickets.find(t => t.id === currentTicketId && t.message === btn.textContent.replace(/^‚úÖ /, ''))) {
          btn.setAttribute('aria-pressed', 'true');
        }
      });
    }

    function updateSendButton() {
      const answerText = document.getElementById('answer-text').value.trim();
      const sendBtn = document.getElementById('send-answer');
      sendBtn.disabled = !answerText || currentTicketId === null || tickets.find(t => t.id === currentTicketId)?.answered;
    }

    // –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
    async function sendAnswer() {
      const answer = document.getElementById('answer-text').value.trim();
      if (!answer || currentTicketId === null) return;

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤ Supabase
      const { error } = await supabase
        .from('tickets')
        .update({ answer, answered: true })
        .eq('id', currentTicketId);

      if (error) {
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞: ' + error.message);
        console.error(error);
        return;
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
      const idx = tickets.findIndex(t => t.id === currentTicketId);
      if (idx !== -1) {
        tickets[idx].answer = answer;
        tickets[idx].answered = true;
      }

      renderTickets();
      selectNextTicket(currentTicketId);
    }

    function selectNextTicket(currentId) {
      const idx = tickets.findIndex(t => t.id === currentId);
      for (let i = idx + 1; i < tickets.length; i++) {
        if (!tickets[i].answered) {
          selectTicket(tickets[i].id);
          return;
        }
      }
      // –ï—Å–ª–∏ –¥–∞–ª—å—à–µ –Ω–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Ç–∏–∫–µ—Ç–æ–≤ ‚Äî —Å–±—Ä–æ—Å –≤—ã–±–æ—Ä–∞
      currentTicketId = null;
      document.getElementById('client-message').textContent = '';
      document.getElementById('answer-text').value = '';
      updateSendButton();
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    async function startShift() {
      document.getElementById('welcome-screen').style.display = 'none';
      document.getElementById('work-screen').style.display = 'flex';

      await fetchTickets();
      renderTickets();

      // –ê–≤—Ç–æ–≤—ã–±–æ—Ä –ø–µ—Ä–≤–æ–≥–æ –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω–æ–≥–æ —Ç–∏–∫–µ—Ç–∞
      const firstOpen = tickets.find(t => !t.answered);
      if (firstOpen) selectTicket(firstOpen.id);
      else {
        // –ï—Å–ª–∏ —Ç–∏–∫–µ—Ç–æ–≤ –Ω–µ—Ç –∏–ª–∏ –≤—Å–µ –æ—Ç–≤–µ—á–µ–Ω—ã
        currentTicketId = null;
        document.getElementById('client-message').textContent = '–ù–µ—Ç –æ—Ç–∫—Ä—ã—Ç—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π.';
        document.getElementById('answer-text').value = '';
        updateSendButton();
      }
    }

    // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–º–µ–Ω—ã ‚Äî –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ —Å—Ç–∞—Ä—Ç–æ–≤—ã–π —ç–∫—Ä–∞–Ω
    function endShift() {
      currentTicketId = null;
      tickets = [];
      document.getElementById('work-screen').style.display = 'none';
      document.getElementById('welcome-screen').style.display = 'flex';
      document.getElementById('nickname').textContent = nickname;
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let nickname = '...';

    // –°–ª—É—à–∞—Ç–µ–ª–∏
    document.getElementById('start-shift-btn').onclick = startShift;
    document.getElementById('send-answer').onclick = sendAnswer;
    document.getElementById('answer-text').addEventListener('input', updateSendButton);
    document.getElementById('end-shift').onclick = endShift;

    // –ü–æ–ª—É—á–∞–µ–º –Ω–∏–∫ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
    (async () => {
      nickname = await loadUserNickname();
      document.getElementById('nickname').textContent = nickname;
    })();
  </script>
</body>
</html>
